<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Code-Barres - Bon de Livraison</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .scan-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-add {
            background: #28a745;
            color: white;
        }
        
        .btn-add:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-export {
            background: #007bff;
            color: white;
        }
        
        .btn-export:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn-clear {
            background: #dc3545;
            color: white;
        }
        
        .btn-clear:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-palette {
            background: #ff9800;
            color: white;
        }
        
        .btn-palette:hover {
            background: #e68900;
            transform: translateY(-2px);
        }
        
        .data-table {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #scanner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #scanner-container.active {
            display: flex;
        }

        #interactive {
            width: 100%;
            max-width: 640px;
            height: 480px;
        }

        #interactive video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .close-scanner-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-camera {
            background: #17a2b8;
            color: white;
        }

        .btn-camera:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .scan-section, .button-group {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ Scanner Code-Barres - Bon de Livraison</h1>
        
        <div id="message" class="message"></div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalItems">0</div>
                <div class="stat-label">Articles Scann√©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalQuantity">0</div>
                <div class="stat-label">Quantit√© Totale</div>
            </div>
        </div>
        
        <div class="scan-section">
            <div class="input-group">
                <label for="paletteNumber" style="color: #667eea; font-size: 18px;">üéØ Num√©ro de Palette</label>
                <input type="text" id="paletteNumber" placeholder="Entrez le num√©ro de palette (ex: PAL001)" style="border: 3px solid #667eea; font-weight: bold;">
                <small style="color: #667eea; display: block; margin-top: 5px;">
                    ‚ö†Ô∏è <strong>Important :</strong> Saisissez le num√©ro de palette avant d'ajouter les articles
                </small>
            </div>
            
            <hr style="margin: 20px 0; border: none; border-top: 2px solid #e0e0e0;">
            
            <div class="input-group">
                <label for="barcodeInput">Scanner le Code-Barres ou Saisie Manuelle</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="barcodeInput" placeholder="Scanner: CABLE123;25;ORD456" style="flex: 1;">
                    <button class="btn-camera" onclick="openCamera()" style="padding: 12px 20px; white-space: nowrap;">üì∑ Cam√©ra</button>
                </div>
                <small style="color: #666; display: block; margin-top: 5px;">
                    üîç <strong>Scan automatique :</strong> Format: Code;Quantit√©;Ordre (s'ajoute automatiquement)<br>
                    üì∑ <strong>Utiliser la cam√©ra :</strong> Cliquez sur le bouton Cam√©ra pour scanner avec votre appareil<br>
                    ‚úçÔ∏è <strong>Saisie manuelle :</strong> Remplissez les champs ci-dessous
                </small>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px;">
                <div class="input-group" style="margin-bottom: 0;">
                    <label for="manualCode">Code</label>
                    <input type="text" id="manualCode" placeholder="CABLE123">
                </div>
                <div class="input-group" style="margin-bottom: 0;">
                    <label for="manualQuantity">Quantit√©</label>
                    <input type="number" id="manualQuantity" placeholder="25">
                </div>
                <div class="input-group" style="margin-bottom: 0;">
                    <label for="manualOrdre">Ordre</label>
                    <input type="text" id="manualOrdre" placeholder="ORD456">
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn-add" onclick="addManualEntry()">‚ûï Ajouter Saisie Manuelle</button>
                <button class="btn-export" onclick="exportToExcel()">üì• Exporter vers Excel</button>
                <button class="btn-clear" onclick="clearAll()">üóëÔ∏è Tout Effacer</button>
                <button class="btn-palette" onclick="clearPalette()">üîÑ Changer Palette</button>
            </div>
        </div>
        
        <div class="data-table">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>N¬∞ Palette</th>
                        <th>Code</th>
                        <th>Quantit√©</th>
                        <th>Ordre</th>
                        <th>Date/Heure</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Scanner Camera Container -->
    <div id="scanner-container">
        <div id="interactive" class="viewport"></div>
        <div class="scanner-controls">
            <button class="close-scanner-btn" onclick="closeCamera()">‚ùå Fermer la Cam√©ra</button>
        </div>
    </div>

    <script>
        let scannedData = [];
        let counter = 1;
        let cameraActive = false;

        // Focus sur l'input palette au chargement
        window.addEventListener('load', function() {
            document.getElementById('paletteNumber').focus();
        });

        // √âcouter l'√©v√©nement Enter pour ajout automatique
        document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addBarcode();
            }
        });

        // Ajout automatique apr√®s scan (d√©tection automatique)
        let scanBuffer = '';
        let scanTimeout;
        
        document.getElementById('barcodeInput').addEventListener('input', function(e) {
            clearTimeout(scanTimeout);
            scanTimeout = setTimeout(() => {
                // Si le champ contient des donn√©es et 2 points-virgules, c'est probablement un scan
                const value = e.target.value.trim();
                if (value && (value.match(/;/g) || []).length === 2) {
                    addBarcode();
                }
            }, 100); // D√©lai de 100ms apr√®s la fin de la saisie
        });

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type;
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
            }, 3000);
        }

        function addManualEntry() {
            const paletteNumber = document.getElementById('paletteNumber').value.trim();
            const code = document.getElementById('manualCode').value.trim();
            const quantity = document.getElementById('manualQuantity').value.trim();
            const ordre = document.getElementById('manualOrdre').value.trim();

            if (!paletteNumber) {
                showMessage('‚ö†Ô∏è Veuillez d\'abord saisir le num√©ro de palette!', 'error');
                document.getElementById('paletteNumber').focus();
                return;
            }

            if (!code || !quantity || !ordre) {
                showMessage('Veuillez remplir tous les champs (Code, Quantit√©, Ordre)', 'error');
                return;
            }

            // V√©rifier si la quantit√© est un nombre
            if (isNaN(quantity) || parseFloat(quantity) <= 0) {
                showMessage('La quantit√© doit √™tre un nombre positif!', 'error');
                return;
            }

            // Ajouter aux donn√©es
            const now = new Date();
            const dateTime = now.toLocaleString('fr-FR');
            
            const entry = {
                id: counter++,
                palette: paletteNumber,
                code: code,
                quantity: parseFloat(quantity),
                ordre: ordre,
                dateTime: dateTime
            };

            scannedData.push(entry);
            updateTable();
            updateStats();
            
            // Vider les champs manuels
            document.getElementById('manualCode').value = '';
            document.getElementById('manualQuantity').value = '';
            document.getElementById('manualOrdre').value = '';
            
            // Refocus sur le premier champ
            document.getElementById('manualCode').focus();
            
            showMessage('Article ajout√© avec succ√®s!', 'success');
        }

        function addBarcode() {
            const paletteNumber = document.getElementById('paletteNumber').value.trim();
            const input = document.getElementById('barcodeInput');
            const barcode = input.value.trim();

            if (!paletteNumber) {
                showMessage('‚ö†Ô∏è Veuillez d\'abord saisir le num√©ro de palette!', 'error');
                document.getElementById('paletteNumber').focus();
                input.value = '';
                return;
            }

            if (!barcode) {
                showMessage('Veuillez scanner ou saisir un code-barres', 'error');
                return;
            }

            // S√©parer les donn√©es par ";"
            const parts = barcode.split(';');
            
            if (parts.length !== 3) {
                showMessage('Format incorrect! Utilisez: code;quantit√©;ordre', 'error');
                input.value = '';
                input.focus();
                return;
            }

            const code = parts[0].trim();
            const quantity = parts[1].trim();
            const ordre = parts[2].trim();

            if (!code || !quantity || !ordre) {
                showMessage('Code, quantit√© ou ordre manquant!', 'error');
                input.value = '';
                input.focus();
                return;
            }

            // V√©rifier si la quantit√© est un nombre
            if (isNaN(quantity)) {
                showMessage('La quantit√© doit √™tre un nombre!', 'error');
                input.value = '';
                input.focus();
                return;
            }

            // Ajouter aux donn√©es
            const now = new Date();
            const dateTime = now.toLocaleString('fr-FR');
            
            const entry = {
                id: counter++,
                palette: paletteNumber,
                code: code,
                quantity: parseFloat(quantity),
                ordre: ordre,
                dateTime: dateTime
            };

            scannedData.push(entry);
            updateTable();
            updateStats();
            
            // Vider l'input et refocus automatiquement
            input.value = '';
            input.focus();
            
            showMessage('Article ajout√© avec succ√®s!', 'success');
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            scannedData.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td><strong style="color: #667eea;">${item.palette}</strong></td>
                    <td>${item.code}</td>
                    <td>${item.quantity}</td>
                    <td>${item.ordre}</td>
                    <td>${item.dateTime}</td>
                    <td><button class="delete-btn" onclick="deleteRow(${index})">Supprimer</button></td>
                `;
            });
        }

        function updateStats() {
            document.getElementById('totalItems').textContent = scannedData.length;
            const totalQty = scannedData.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('totalQuantity').textContent = totalQty;
        }

        function deleteRow(index) {
            scannedData.splice(index, 1);
            updateTable();
            updateStats();
            showMessage('Article supprim√©', 'success');
        }

        function clearPalette() {
            const paletteInput = document.getElementById('paletteNumber');
            if (paletteInput.value.trim() === '') {
                showMessage('Le champ palette est d√©j√† vide', 'error');
                return;
            }
            
            if (confirm('Voulez-vous changer de palette? (Le num√©ro actuel sera effac√©)')) {
                paletteInput.value = '';
                paletteInput.focus();
                showMessage('Vous pouvez maintenant saisir un nouveau num√©ro de palette', 'success');
            }
        }

        function clearAll() {
            if (scannedData.length === 0) {
                showMessage('Aucune donn√©e √† effacer', 'error');
                return;
            }
            
            if (confirm('√ätes-vous s√ªr de vouloir effacer toutes les donn√©es?')) {
                scannedData = [];
                counter = 1;
                updateTable();
                updateStats();
                showMessage('Toutes les donn√©es ont √©t√© effac√©es', 'success');
            }
        }

        function exportToExcel() {
            if (scannedData.length === 0) {
                showMessage('Aucune donn√©e √† exporter', 'error');
                return;
            }

            // Pr√©parer les donn√©es pour Excel
            const excelData = scannedData.map(item => ({
                'N¬∞': item.id,
                'N¬∞ Palette': item.palette,
                'Code': item.code,
                'Quantit√©': item.quantity,
                'Ordre': item.ordre,
                'Date/Heure': item.dateTime
            }));

            // Cr√©er le workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);

            // Ajuster la largeur des colonnes
            ws['!cols'] = [
                { wch: 5 },
                { wch: 15 },
                { wch: 20 },
                { wch: 12 },
                { wch: 20 },
                { wch: 20 }
            ];

            // Ajouter la feuille au workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Bon de Livraison');

            // G√©n√©rer le nom du fichier avec la date
            const now = new Date();
            const fileName = `Bon_Livraison_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.xlsx`;

            // T√©l√©charger le fichier
            XLSX.writeFile(wb, fileName);
            
            showMessage('Fichier Excel export√© avec succ√®s!', 'success');
        }

        // Fonctions de la cam√©ra
        function openCamera() {
            const paletteNumber = document.getElementById('paletteNumber').value.trim();
            
            if (!paletteNumber) {
                showMessage('‚ö†Ô∏è Veuillez d\'abord saisir le num√©ro de palette!', 'error');
                document.getElementById('paletteNumber').focus();
                return;
            }

            document.getElementById('scanner-container').classList.add('active');
            cameraActive = true;
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment"
                    },
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ]
                },
            }, function(err) {
                if (err) {
                    console.error(err);
                    showMessage('Erreur d\'acc√®s √† la cam√©ra: ' + err, 'error');
                    closeCamera();
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                if (cameraActive && result.codeResult.code) {
                    const code = result.codeResult.code;
                    document.getElementById('barcodeInput').value = code;
                    
                    // V√©rifier si c'est au bon format
                    if ((code.match(/;/g) || []).length === 2) {
                        addBarcode();
                    } else {
                        showMessage('Code scann√©: ' + code + ' - Ajoutez ;quantit√©;ordre', 'success');
                    }
                    
                    // Fermer la cam√©ra apr√®s le scan
                    setTimeout(() => {
                        closeCamera();
                    }, 500);
                }
            });
        }

        function closeCamera() {
            cameraActive = false;
            document.getElementById('scanner-container').classList.remove('active');
            Quagga.stop();
        }
    </script>
</body>
</html>
